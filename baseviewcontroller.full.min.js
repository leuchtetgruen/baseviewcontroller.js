
var BaseModel=Backbone.Model.extend({get:function(attr){if((typeof(this[attr])=="function")&&this[attr].toString().match(/function.\(\)/)){return this[attr]();}
else{return Backbone.Model.prototype.get.call(this,attr);}},bindView:function(attr,view,save){this[attr]=view;var that=this;view.set(this.get(attr));view.on("change",function(){that.set(attr,view());});this.on("change:"+attr,function(model,value){view.set(value);if(save)model.save();});},_attributes:function(){var withoutAttrs=["constructor"].concat(_.keys(Backbone.Model.prototype)).concat(_.keys(Backbone.Model));var nativeAttrs=_.keys(this.attributes);var myAttrs=_.keys(this.__proto__);var that=this;var myFctAttrs=_.filter(myAttrs,function(attr){return(typeof(that[attr]=="function")&&that[attr].toString().match(/function.\(\)/));});return _.difference(nativeAttrs.concat(myFctAttrs),withoutAttrs);},toJSON:function(){var ret={};var attrs=this._attributes();for(i in attrs){attr=attrs[i];ret[attr]=this.get(attr);}
return ret;},});var BaseViewFunctions={bindTo:function(otherElem){this.on("change",function(val){otherElem.set(val);});var that=this;otherElem.on("change",function(val){that.set(val);});},copyElementFunctions:function(){var that=this;var elem=this.element;var fcts=[];for(var key in elem){if((typeof(elem[key]=="function"))&&(typeof(this[key])=="undefined")){fcts.push(key);}}
_.each(fcts,function(fctName){that[fctName]=function(){elem[fctName].apply(elem,arguments);};});},getClassByName:function(name){if(name.match(/[A-Za-z0-9]+/)){return eval(name);}
else return null;},};var Valuable=function(elem,vc,mixins){var f=function(){return elem.val();};_.extend(f,Backbone.Events);_.extend(f,BaseViewFunctions);if(mixins)_.extend(f,mixins);f.set=function(val,dontTrigger){elem.val(val);if(!dontTrigger)this.trigger("change",val);};f.get=function(){return elem.val();};f.toString=function(){return"Valuable based on #"+$(elem).attr("id")+" => "+this.get();};elem.change(function(e){f.trigger("change",elem.val());});f.element=elem;f.copyElementFunctions();f.attachedViewController=vc;return f;};var HTMLable=function(elem,vc,mixins){var f=function(){return elem.html();};_.extend(f,Backbone.Events);_.extend(f,BaseViewFunctions);if(mixins)_.extend(f,mixins);f.set=function(val,dontTrigger){elem.html(val);if(!dontTrigger)this.trigger("change",val);};f.get=function(){return elem.html();};f.toString=function(){return"HTMLable based on #"+$(elem).attr("id")+" => "+this.get();}
elem.on("blur",function(e){f.trigger("change",elem.html());});elem.on("DOMCharacterDataModified",function(e){if(elem.attr("contenteditable")!="true"){f.trigger("change",elem.html());}});f.element=elem;f.copyElementFunctions();f.attachedViewController=vc;return f;};var Container=function(elem,vc,mixins){var f=function(){return this.childViews;};f.childViews=_.map($(elem).children(),function(child){var childView=vc.injectView($(child));childView.parentContainer=f;return childView;});_.extend(f,Backbone.Events);_.extend(f,BaseViewFunctions);if(mixins)_.extend(f,mixins);f.get=function(){return this.childViews;};f.append=function(view){this.childViews.push(view);elem.append(view.element);view.parentContainer=this;};f.resetChildren=function(){_.each(this.childViews,function(child){$(child.element).remove();});this.childViews=[];};f.toString=function(){return"Container based on #"+$(elem).attr("id")+" => ["+_.map(this.childViews,function(c){return c.toString();})+"]";}
f.element=elem;f.copyElementFunctions();f.attachedViewController=vc;return f;}
var ContentView=HTMLable;var ViewTypes={"contentview":ContentView,"container":Container,};var BaseViewController=Backbone.View.extend({transitionTo:function(ViewControllerClass,element,data){if(data&&data['empty']){_doHide=data['empty'];data=_.omit(data,'empty');}
else _doHide=false;this.hide(_doHide);var extendedData=_.extend({fromViewController:this},data);var MixedVcClass=ViewControllerClass.extend(extendedData);new MixedVcClass({el:element});},transitionBack:function(){if(this.fromViewController){this.hide();this.fromViewController.show();}},_hide:function(doEmpty){var that=this;this.animateHide(function(){that.$el.hide();if((doEmpty==undefined)||(doEmpty))that.$el.empty();});},_show:function(){window.visibleViewController=this;window.$el=this.$el;this.$el.show();this.$el.css("z-index",1000);this.animateShow();},animateShow:function(callback){if(this.hasAnimationProperty()){visibleClass=this.getAnimationVisibleClass();invisibleClass=this.getAnimationInvisibleClass();this.$el.removeClass("animatable");this.$el.removeClass(visibleClass);this.$el.addClass(invisibleClass);var that=this;window.setTimeout(function(){that.$el.bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){that.$el.removeClass(invisibleClass);that.$el.unbind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd");if(callback)callback();});that.$el.addClass("animatable");that.$el.addClass(visibleClass);},50);}
else if(callback)callback();},animateHide:function(callback){if(this.hasAnimationProperty()){visibleClass=this.getAnimationVisibleClass();invisibleClass=this.getAnimationInvisibleClass();var that=this;this.$el.bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){if(callback){callback();}
that.$el.unbind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd");});that.$el.removeClass(visibleClass);this.$el.addClass("animatable");this.$el.addClass(invisibleClass);}
else if(callback){callback();}},hasAnimationProperty:function(){return(this.transition);},getAnimationVisibleClass:function(){return"visible-"+this.transition;},getAnimationInvisibleClass:function(){return"invisible-"+this.transition;},hide:function(doEmpty){this._hide(doEmpty);},show:function(){this._show();},_render:function(url,values,callback){$.ajaxSetup({cache:false});that=this;$.get(url,function(data){rendered_html_fct=_.template(data);rendered_html=rendered_html_fct(values||{});that.$el.html(rendered_html);that.$el.ready(function(){that.injectViews(that.$el,0);});that.show();if(callback)callback(data);if(that.doneRendering&&(typeof(that.doneRendering)=="function"))that.doneRendering(data);});},render:function(){if(!this.template_url){console.error("no template_url property provided in the view controller");return;}
else{this._render(this.template_url);}},injectViews:function(root,level){if(level>5)return;this.injectView(root);var children=$(root).children();if(children.length>0){for(var i=0;i<children.length;i++){var child=$(children[i]);this.injectViews(child,level+1);}
this.delegateEvents();}},injectView:function(elem){if(elem.attr("id")&&this[elem.attr("id")])return;var viewType=elem.attr("view-type");for(var vType in ViewTypes){if(viewType==vType){var view=ViewTypes[vType].apply(ViewTypes[vType],[elem,this]);if(view.initialize){view.initialize();}
if(elem.attr("id"))this[elem.attr("id")]=view;this.parseEvents(elem);return view;}}},parseEvents:function(elem){if(!elem.attr("view-events"))return;if(!this.events){this.events={};}
var that=this;var viewEvents=elem.attr("view-events").split(",");_.each(viewEvents,function(eventString){var splitted=eventString.split(":");if(splitted.length==2){var fullEventSelector=splitted[0].trim()+" #"+elem.attr("id");that.events[fullEventSelector]=splitted[1].trim();}});},});var TextView=Valuable;var Slider=Valuable;var Toggleable=function(elem,vc,mixins){var f=function(){return elem.hasClass("toggleable-checked");};_.extend(f,Backbone.events);_.extend(f,BaseViewFunctions);if(mixins)_.extend(f,mixins);f.set=function(val,dontTrigger){if(val)elem.addClass("toggleable-checked");else elem.removeClass("toggleable-checked");if(!dontTrigger)this.trigger("change",val);};f.get=function(){return elem.hasClass("toggleable-checked");};f.toggle=function(dontTrigger){this.set(!this.get(),dontTrigger);};f.toString=function(){return"Toggleable based on #"+$(elem).attr("id")+" => "+this.get();};elem.click(function(){f.toggle();});elem.addClass("toggleable");f.element=elem;f.copyElementFunctions();f.attachedViewController=vc;return f;};var ContentEditable=function(elem,vc,mixins){var myMixins={setEditable:function(editable){$(elem).attr("contenteditable",editable);},isEditable:function(){return($(elem).attr("contenteditable")=="true");},};mergedMixins=_.extend(mixins||{},myMixins);return HTMLable(elem,vc,mergedMixins);};ViewTypes["textview"]=TextView;ViewTypes["slider"]=Slider;ViewTypes["toggleable"]=Toggleable;ViewTypes["editable-content"]=ContentEditable;var CollectionsAdapter={count:function(){return this._filteredCollection().length;},_filteredCollection:function(){if(this.filter){var that=this;return this.collection.filter(function(obj){return that.filter(obj);});}
else{return this.collection.filter(function(obj){return true;});}},build:function(idx){if(this.buildItemFromModel){var model=this._filteredCollection()[idx];var builtFromModel=this.buildItemFromModel(model);if(model.isNew()){builtFromModel.addClass("new-model");}
return builtFromModel;}
else{return $('<li>'+this._filteredCollection()[idx].toString()+"</li>");}},selectedItem:function(idx){if(this.selectedItemFromModel){this.selectedItemFromModel(this._filteredCollection()[idx]);}},setCollection:function(_collection){this.collection=_collection;var that=this;_.each(["add","remove","change"],function(evt){that.collection.on(evt,function(){console.log(evt+" thrown");that.rebuildListView();});});},extend:function(extension){return _.extend(_.clone(this),extension);},};var ListView=function(elem,vc,mixins){var myMixins={initialize:function(){$(this.element).addClass("listview");var adapterName=$(this.element).attr("view-adapter");if(adapterName){var adapterClass=this.getClassByName(adapterName);if(adapterClass){this.setAdapter(adapterClass);}}},setAdapter:function(_adapter){this.adapter=_adapter;this.adapter.listView=this;this.adapter.attachedViewController=vc;var that=this;this.adapter.rebuildListView=function(){that.build();};},build:function(){if(!this.adapter)return null;if(!this.adapter.count)return null;if(!this.adapter.build)return null;var that=this;var clickHandlerProducer=function(idx){return function(){that.adapter.selectedItem(idx);}};this.resetChildren();for(var i=0;i<this.adapter.count();i++){var elem=this.adapter.build(i);var lItem=new ListItem(elem,vc);lItem.initialize();if(this.adapter.selectedItem){lItem.click(clickHandlerProducer(i));}
this.append(lItem);if(this.adapter.customizeListItem){this.adapter.customizeListItem(lItem,i);}}},};mergedMixins=_.extend(mixins||{},myMixins);return Container(elem,vc,mergedMixins);};var ListItem=function(elem,vc,mixins){var myMixins={initialize:function(){$(this.element).addClass("listitem");}};mergedMixins=_.extend(mixins||{},myMixins);return HTMLable(elem,vc,mergedMixins);};ViewTypes["listview"]=ListView;ViewTypes["listitem"]=ListItem;var TabView=function(elem,vc,mixins){var myMixins={initialize:function(){$(this.element).addClass("tabview");var tabViewContentViewId=$(this.element).attr("tabview-content-view");if(tabViewContentViewId){this.setContentElement($("#"+tabViewContentViewId));}},setContentElement:function(element){this.contentElement=element;},loadDefaultTab:function(){this.childViews[0].click();},}
mergedMixins=_.extend(mixins||{},myMixins);return Container(elem,vc,mergedMixins);};var TabItem=function(elem,vc,mixins){var myMixins={initialize:function(){$(this.element).addClass("tab");var vcName=$(this.element).attr("view-controller");if(vcName){var vcClass=this.getClassByName(vcName);if(vcClass){this.setViewController(vcClass);}};},setViewController:function(viewControllerClass){var that=this;this.click(function(){var children=$(that.parentContainer.element).children();for(var i=0;i<children.length;i++){$(children[i]).removeClass("active-tab");}
$(elem).addClass("active-tab");var MixedVcClass=viewControllerClass.extend({parentViewController:vc});new MixedVcClass({el:$(that.parentContainer.contentElement)});});}};mergedMixins=_.extend(mixins||{},myMixins);return HTMLable(elem,vc,mergedMixins);};ViewTypes["tabview"]=TabView;ViewTypes["tabitem"]=TabItem;var BackLink=function(elem,vc,mixins){var myMixins={initialize:function(){$(this.element).click(function(e){vc.transitionBack();e.preventDefault();});},};mergedMixins=_.extend(myMixins,mixins);return HTMLable(elem,vc,mergedMixins);};ViewTypes["backlink"]=BackLink;